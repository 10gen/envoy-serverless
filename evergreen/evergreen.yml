tasks:
- name: compile
  commands:
    - command: git.get_project
      params:
        directory: src
    - func: "compile envoy"
- name: test
  commands:
    - command: git.get_project
      params:
        directory: src
    - func: "test envoy"
- name: upload
  commands:
    - command: git.get_project
      params:
        directory: src
    - func: "s3 upload release binaries"

functions:
  "compile envoy":
    command: subprocess.exec
    params:
      binary: bash
      args:
      - "src/evergreen/compile-centos7-evergreen.sh"
  "test envoy":
    command: subprocess.exec
    params:
      binary: bash
      args:
      - "src/evergreen/test-centos7-evergreen.sh"
  "s3 upload release binaries":
    command: s3.put
    params:
      aws_key: ${release_aws_key}
      aws_secret: ${release_aws_secret}
      bucket: mongodb-mms-build-envoy-serverless
      local_file: src/README.md
      remote_file: tarballs/${revision}/README.md
      permissions: public-read
      content_type: "text/plain"
      display_name: README.md

buildvariants:
- name: centos7
  display_name: CentOS 7
  run_on:
    # Tasks run in x86 CentOS7 containers, so the Linux distro doesn't have to match.
    - rhel80-xlarge
  expansions:
    release: 7
    image: centos:7
    arch: x86_64
  tasks:
  - name: compile
  - name: test
  - name: upload

