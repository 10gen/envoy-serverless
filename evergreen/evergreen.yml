tasks:
- name: compile
  commands:
    - command: git.get_project
      params:
        directory: src
    - func: "compile envoy"
    - func: "archive"
    - func: "s3 upload archive"
- name: test
  commands:
    - command: git.get_project
      params:
        directory: src
    - func: "test envoy"

functions:
  "compile envoy":
    command: subprocess.exec
    params:
      binary: bash
      args:
      - "src/evergreen/compile-centos7-evergreen.sh"
  "test envoy":
    command: subprocess.exec
    params:
      binary: bash
      args:
      - "src/evergreen/test-centos7-evergreen.sh"
  "archive":
    command: subprocess.exec
    params:
      binary: bash
      args:
      - "src/evergreen/archive-evergreen.sh"
  "s3 upload archive":
    command: s3.put
    params:
      aws_key: ${release_aws_key}
      aws_secret: ${release_aws_secret}
      bucket: mongodb-mms-build-envoy-serverless
      local_files_include_filter: ["envoy-serverless-*.tar.gz"]
      remote_file: tarballs/${revision}/
      permissions: public-read
      content_type: "application/x-gzip"
      display_name: envoy-serverlss.tar.gz

buildvariants:
- name: centos7
  display_name: CentOS 7
  run_on:
    # Tasks run in x86 CentOS7 containers, so the Linux distro doesn't have to match.
    - rhel80-xlarge
  expansions:
    release: 7
    image: centos:7
    arch: x86_64
  tasks:
  - name: compile
  - name: test

