tasks:
- name: compile
  commands:
    - command: git.get_project
      params:
        directory: src
    - func: "compile envoy"
    - func: "archive"
    - func: "s3 upload archive"
- name: test
  commands:
    - command: git.get_project
      params:
        directory: src
    - func: "test envoy"
- name: push
  depends_on:
    - name: compile
  commands:
    - func: "s3 push archive"

functions:
  "compile envoy":
    command: subprocess.exec
    params:
      binary: bash
      args:
      - "src/evergreen/compile-centos7-evergreen.sh"
  "test envoy":
    command: subprocess.exec
    params:
      binary: bash
      args:
      - "src/evergreen/test-centos7-evergreen.sh"
  "archive":
    command: subprocess.exec
    params:
      binary: bash
      args:
      - "src/evergreen/archive-evergreen.sh"
  "s3 upload archive":
    command: s3.put
    params:
      aws_key: ${release_aws_key}
      aws_secret: ${release_aws_secret}
      bucket: mongodb-mms-build-envoy-serverless
      local_files_include_filter: ["*.tar.gz"]
      local_files_include_filter_prefix: "archive"
      remote_file: build/${build_id}/
      permissions: public-read
      content_type: "application/x-gzip"
  "s3 push archive":
    command: s3Copy.copy
    params:
      aws_key: ${release_aws_key}
      aws_secret: ${release_aws_secret}
      s3_copy_files:
      - {'optional': false, 'source': {'path': 'build/${build_id}/envoy-serverless*.tar.gz', 'bucket': 'mongodb-mms-build-envoy-serverless'}, 'destination': {'path': 'tarballs/', 'bucket': 'mongodb-mms-build-envoy-serverless'}}

buildvariants:
- name: centos7
  display_name: CentOS 7
  run_on:
    # Tasks run in x86 CentOS7 containers, so the Linux distro doesn't have to match.
    - rhel80-xlarge
  tasks:
  - name: compile
  - name: test
  - name: push

